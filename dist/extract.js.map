{"version":3,"sources":["../src/extract.ts"],"names":["readFileAsync","readFile","extract","postcss","plugin","callback","root","parsedClassnames","walkRules","rule","classNodes","getClassNodesFromRule","classnames","map","classNode","value","filter","Boolean","push","selectors","walkClasses","processSync","extractClassnames","inputFilenames","postcssConfig","process","cwd","config","undefined","Promise","all","inputFilename","absInputFilename","relativeInputFilename","log","print","debug","inputFile","resolve","reject","plugins","options","from","then","results","warnings","length","warn","catch","error","flatClassnames","reduce","acc","cx","concat","index","indexOf"],"mappings":"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","sourcesContent":["import postcss from 'postcss';\nimport loadConfig from 'postcss-load-config';\nimport selectorParser, { Node } from 'postcss-selector-parser';\nimport { isAbsolute, resolve, relative } from 'path';\nimport { promisify } from 'util';\nimport { readFile } from 'fs';\nimport * as log from 'cli-tag-logger';\n\nconst readFileAsync = promisify(readFile);\n\nconst extract = postcss.plugin(\n  'postcss-extract-class',\n  (callback?: (classnames: string[]) => void) => {\n    return root => {\n      const parsedClassnames: string[] = [];\n      root.walkRules(rule => {\n        const classNodes = getClassNodesFromRule(rule);\n        const classnames = classNodes\n          .map(classNode => classNode.value)\n          .filter(Boolean) as string[];\n        parsedClassnames.push(...classnames);\n      });\n      callback && callback(parsedClassnames);\n    };\n  }\n);\n\nfunction getClassNodesFromRule(rule: postcss.Rule) {\n  const classNodes: Node[] = [];\n\n  selectorParser(selectors => {\n    selectors.walkClasses(classNode => {\n      classNodes.push(classNode);\n    });\n  }).processSync(rule);\n\n  return classNodes;\n}\n\nexport async function extractClassnames(\n  inputFilenames: string[],\n  postcssConfig: string = process.cwd()\n) {\n  const config = await loadConfig(undefined, postcssConfig);\n  try {\n    const classnames = await Promise.all(\n      inputFilenames.map(async inputFilename => {\n        const absInputFilename = isAbsolute(inputFilename)\n          ? inputFilename\n          : resolve(inputFilename);\n        const relativeInputFilename = relative(process.cwd(), absInputFilename);\n        log.print(log.debug`Processing ${relativeInputFilename}`);\n\n        const inputFile = await readFileAsync(absInputFilename, 'utf8');\n        return new Promise<string[]>((resolve, reject) => {\n          postcss([...config.plugins, extract(resolve)])\n            .process(inputFile, { ...config.options, from: undefined })\n            .then(results => {\n              const warnings = results.warnings();\n              log.print(log.debug`Extracted ${relativeInputFilename}`);\n              if (warnings.length) {\n                log.print(log.warn`${warnings}`);\n              }\n              return;\n            })\n            .catch((error: Error) => {\n              reject(error);\n            });\n        });\n      })\n    );\n\n    const flatClassnames = classnames.reduce((acc, cx) => {\n      return acc.concat(...cx);\n    }, []);\n\n    // Remove duplicates\n    return flatClassnames.filter((cx, index) => {\n      return flatClassnames.indexOf(cx, index + 1) === -1;\n    });\n  } catch (error) {\n    log.print(log.error`Class names extraction failed`);\n    throw error;\n  }\n}\n"],"file":"extract.js"}